<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Finanza Desktop</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="icon" href="../IMAGENS/logo.png">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .chart-container {
            width: 100%;
            max-width: 600px;
            margin: 2rem auto 1rem auto;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="sidebar"></div>
        <div class="main-content">
            <!-- Estatísticas/resumo financeiro -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value stat-balance" id="saldoTotal">R$ 0,00</div>
                    <div class="stat-label">Saldo Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-income" id="receitasMes">R$ 0,00</div>
                    <div class="stat-label">Receitas do Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-expense" id="despesasMes">R$ 0,00</div>
                    <div class="stat-label">Despesas do Mês</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value stat-accounts" id="contasCadastradas">0</div>
                    <div class="stat-label">Contas cadastradas</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Resumo Financeiro</h2>
                </div>
                <div id="financialSummary">
                    <p id="contasResumo">Você possui <strong>0</strong> contas cadastradas.</p>
                    <p id="receitaResumo">Neste mês você teve <strong>R$ 0,00</strong> em receitas e <strong>R$ 0,00</strong> em despesas.</p>
                    <p id="saldoResumo">Seu saldo atual é de <strong>R$ 0,00</strong>.</p>
                </div>
                <!-- Gráfico de despesas por categoria -->
                <div class="chart-container">
                    <canvas id="despesasPorCategoriaChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAtmg3jhdlvF_GJmfLRt_bHCGRw_nWSMCo",
            authDomain: "finanza-2cd68.firebaseapp.com",
            databaseURL: "https://finanza-2cd68-default-rtdb.firebaseio.com",
            projectId: "finanza-2cd68",
            storageBucket: "finanza-2cd68.appspot.com",
            messagingSenderId: "991299806624",
            appId: "1:991299806624:web:12782bf4a0ab6ed52630c5",
            measurementId: "G-M1TCD97PRW"
        };
        firebase.initializeApp(firebaseConfig);

        // adminEmails sempre minusculo para evitar problemas de case sensitive
        const adminEmails = ["admin@finanza.com", "seu_email_admin@dominio.com", "kallebyschultz@gmail.com"].map(e => e.trim().toLowerCase());

        function generateSidebar(user) {
            // debug: veja o email no console!
            console.log('Sidebar: user.email =', user.email);
            // sempre minusculo e sem espaços
            const userEmail = (user && user.email) ? user.email.trim().toLowerCase() : "";
            const isAdmin = adminEmails.includes(userEmail);

            return `
                <div class="sidebar">
                    <div class="sidebar-logo">
                        <img src="../IMAGENS/logo.png" alt="Logo Finanza" class="logo" />
                        <h2>Finanza</h2>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a href="dashboard.html" class="nav-link active">Dashboard</a></li>
                        <li class="nav-item"><a href="accounts.html" class="nav-link">Contas</a></li>
                        <li class="nav-item"><a href="transactions.html" class="nav-link">Transações</a></li>
                        <li class="nav-item"><a href="categories.html" class="nav-link">Categorias</a></li>
                        <li class="nav-item"><a href="profile.html" class="nav-link">Perfil</a></li>
                        ${isAdmin ? `<li class="nav-item"><a href="admin.html" class="nav-link">Admin</a></li>` : ""}
                        <li class="nav-item"><a href="#" class="nav-link" id="logoutBtn">Sair</a></li>
                    </ul>
                </div>
            `;
        }

        // Função para buscar dados reais do Firebase Database
        function atualizarDashboard(user) {
            const contasRef = firebase.database().ref('contas/' + user.uid);
            contasRef.on('value', snapshot => {
                const contas = [];
                snapshot.forEach(child => {
                    const conta = child.val();
                    contas.push({ id: child.key, ...conta });
                });

                document.getElementById('contasCadastradas').textContent = contas.length;
                document.getElementById('contasResumo').innerHTML = `Você possui <strong>${contas.length}</strong> contas cadastradas.`;
            });

            // Atualiza receitas/despesas, saldo total e gráfico de despesas
            const transRef = firebase.database().ref('transacoes/' + user.uid);
            const categoriasRef = firebase.database().ref('categorias/' + user.uid);

            const now = new Date();
            const mesAtual = now.getMonth();
            const anoAtual = now.getFullYear();

            let categorias = {};
            categoriasRef.once('value').then(snapshot => {
                snapshot.forEach(child => {
                    categorias[child.key] = child.val().nome;
                });
            });

            transRef.on('value', snapshot => {
                let receitas = 0;
                let despesas = 0;
                let receitasMes = 0;
                let despesasMes = 0;

                let despesasPorCategoria = {};

                snapshot.forEach(child => {
                    const trans = child.val();
                    const valor = trans.valor || 0;
                    if (trans.tipo === 'receita') receitas += valor;
                    if (trans.tipo === 'despesa') despesas += valor;

                    if (trans.tipo === 'despesa' && trans.categoria_id) {
                        const categoriaId = trans.categoria_id;
                        despesasPorCategoria[categoriaId] = (despesasPorCategoria[categoriaId] || 0) + valor;
                    }

                    const data = new Date(trans.data);
                    if (data.getMonth() === mesAtual && data.getFullYear() === anoAtual) {
                        if (trans.tipo === 'receita') receitasMes += valor;
                        if (trans.tipo === 'despesa') despesasMes += valor;
                    }
                });

                const saldoTotal = receitas - despesas;

                document.getElementById('saldoTotal').textContent = 'R$ ' + saldoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('saldoResumo').innerHTML = `Seu saldo atual é de <strong>R$ ${saldoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong>.`;

                document.getElementById('receitasMes').textContent = 'R$ ' + receitasMes.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('despesasMes').textContent = 'R$ ' + despesasMes.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                document.getElementById('receitaResumo').innerHTML = `Neste mês você teve <strong>R$ ${receitasMes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong> em receitas e <strong>R$ ${despesasMes.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</strong> em despesas.`;

                categoriasRef.once('value').then(catSnapshot => {
                    let labels = [];
                    let values = [];
                    catSnapshot.forEach(catChild => {
                        const catId = catChild.key;
                        const catName = catChild.val().nome;
                        if (despesasPorCategoria[catId]) {
                            labels.push(catName);
                            values.push(despesasPorCategoria[catId]);
                        }
                    });
                    renderDespesasPorCategoriaChart(labels, values);
                });
            });
        }

        let despesasChartInstance = null;
        function renderDespesasPorCategoriaChart(labels, values) {
            const ctx = document.getElementById('despesasPorCategoriaChart').getContext('2d');

            if (despesasChartInstance) {
                despesasChartInstance.data.labels = labels;
                despesasChartInstance.data.datasets[0].data = values;
                despesasChartInstance.update();
                return;
            }

            despesasChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gastos por despesa (R$)',
                        data: values,
                        backgroundColor: '#f56565'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: labels.length > 0,
                            text: 'Gastos por Categoria de Despesa'
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Categoria' } },
                        y: { title: { display: true, text: 'Valor (R$)' }, beginAtZero: true }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            firebase.auth().onAuthStateChanged(function(user) {
                if (!user) {
                    setTimeout(() => {
                        window.location.href = "login.html";
                    }, 200);
                    return;
                }
                document.getElementById('sidebar').innerHTML = generateSidebar(user);

                document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    await firebase.auth().signOut();
                    window.location.href = "login.html";
                });

                atualizarDashboard(user);
            });
        });
    </script>
</body>
</html>